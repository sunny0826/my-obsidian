# 日程管理系统脚本说明

## 脚本架构

```
workspace/
├── schedule.json                          # 日程数据存储
├── schedule-manager.js                   # 任务管理（CRUD）
├── sync-schedule.js                      # 双向同步（本地 → Google Calendar）
├── schedule-planner.js                   # 日程规划器（已废弃，保留备查）
└── skills/
    ├── schedule.js                         # 查询今日日程
    └── calendar-bidirectional-sync.js    # 反向同步（Google Calendar → 本地）
```

---

## 核心脚本

### 1. schedule-manager.js
**位置：** workspace/

**功能：** 完整的任务管理

**命令：**
```bash
# 添加任务
node schedule-manager.js add "标题" 2026-02-13 10:00 [类别] [描述]

# 删除任务
node schedule-manager.js delete <taskId>

# 查看今日
node schedule-manager.js today

# 列出所有
node schedule-manager.js list
```

**特性：**
- ✅ 添加任务时自动同步到 Google Calendar
- ✅ 删除任务时自动从 Google Calendar 删除
- ✅ 自动生成 taskId 和 eventId

**使用场景：**
- 用户主动添加/删除任务
- 手动管理日程

---

### 2. sync-schedule.js
**位置：** workspace/

**功能：** 双向同步（本地 → Google Calendar）

**命令：**
```bash
node sync-schedule.js sync
```

**特性：**
- ✅ 从 schedule.json 读取所有任务
- ✅ 同步到 Google Calendar
- ✅ 更新 eventId

**使用场景：**
- 手动触发同步
- Cron 定时同步

---

### 3. calendar-bidirectional-sync.js
**位置：** skills/

**功能：** 反向同步（Google Calendar → 本地）

**命令：**
```bash
node skills/calendar-bidirectional-sync.js sync
node skills/calendar-bidirectional-sync.js status
```

**特性：**
- ✅ 从 Google Calendar 获取今日事件
- ✅ 合并到 schedule.json（避免重复）
- ✅ 自动推断分类

**使用场景：**
- 晨间简报前运行同步
- 用户在 Google Calendar 中添加日程后同步到本地

---

### 4. skills/schedule.js
**位置：** skills/

**功能：** 查询今日日程

**命令：**
```bash
node skills/schedule.js today
node skills/schedule.js list
node skills/schedule.js add ...
```

**特性：**
- ✅ 支持今日查询
- ✅ 支持添加/删除/列表
- ✅ 自然语言命令（使用命名参数）

**使用场景：**
- 晨间简报查询今日待办
- 用户对话中查询日程
- 用户添加/删除日程

---

## 数据流程

### 添加任务流程

```
用户请求
    ↓
skills/schedule.js add
    ↓
schedule-manager.js add
    ↓
创建任务到 schedule.json
    ↓
自动同步到 Google Calendar（schedule-manager.js）
    ↓
返回 eventId
```

### 查询今日流程

```
晨间简报 cron
    ↓
运行 calendar-bidirectional-sync.js sync
    ↓
从 Google Calendar 同步到 schedule.json
    ↓
运行 skills/schedule.js today
    ↓
显示今日日程
```

### 双向同步流程

```
手动触发
    ↓
运行 sync-schedule.js sync
    ↓
从 schedule.json 读取任务
    ↓
同步到 Google Calendar
    ↓
更新 eventId
```

---

## 优化记录

### 已删除的重复脚本

| 脚本 | 原因 |
|------|------|
| calendar-sync.js | 功能被 sync-schedule.js 覆盖 |
| skills/schedule-sync-service.js | 功能被 sync-schedule.js 覆盖 |

### 保留的核心脚本

| 脚本 | 用途 | 唯一性 |
|------|------|---------|
| schedule-manager.js | 任务管理 + 同步到 Google Calendar | ✅ |
| sync-schedule.js | 双向同步（本地 → Google Calendar） | ✅ |
| calendar-bidirectional-sync.js | 反向同步（Google Calendar → 本地） | ✅ |
| skills/schedule.js | 查询今日日程 + 自然语言命令 | ✅ |

---

## 使用建议

### 日常使用

1. **用户对话中查询/添加/删除日程**：
   - 使用 `skills/schedule.js`
   - 自然语言命令，方便快捷

2. **用户在 Google Calendar 中添加日程**：
   - 运行 `calendar-bidirectional-sync.js sync`
   - 或晨间简报会自动运行

3. **手动同步到 Google Calendar**：
   - 运行 `sync-schedule.js sync`

### Cron 配置

```bash
# 晨间简报（8:00）
0 8 * * * node skills/schedule.js today

# 双向同步（每天）
0 9 * * * node skills/calendar-bidirectional-sync.js sync
```

---

## 未来优化方向

1. **统一同步逻辑**：
   - 将 sync-schedule.js 和 calendar-bidirectional-sync.js 合并为一个完整的双向同步脚本

2. **添加冲突检测**：
   - 检测本地和云端的不一致
   - 提供解决建议

3. **添加依赖分析**：
   - 检测任务之间的依赖关系
   - 提供智能排期建议
